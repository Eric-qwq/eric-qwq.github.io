<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>手機下落節奏遊戲</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; background:#111; color:#eee; font-family: "Noto Sans TC", sans-serif;
    overflow:hidden; -webkit-user-select:none; user-select:none;
  }
  #game {
    position: relative; width: 100vw; height: 100vh; background: #222; overflow: hidden;
  }
  #lanes {
    position: absolute; bottom: 0; width: 100%; height: 180px;
    display: flex; justify-content: space-around; align-items: center;
    border-top: 3px solid #444;
  }
  .lane {
    width: 22%; height: 180px; background: #333; border-radius: 14px;
    border: 2px solid #555; box-sizing: border-box; position: relative;
    user-select:none;
  }
  .lane.active {
    border-color: #0f0;
    box-shadow: 0 0 12px #0f0;
  }
  .note {
    width: 60px; height: 60px; background: #08f; border-radius: 50%;
    position: absolute; left: 50%; transform: translateX(-50%);
    box-shadow: 0 0 15px #08f;
    bottom: 180px; /* 初始在最上方，往下掉 */
    transition: bottom 0.05s linear;
  }
  .note.hit {
    background: #0f0 !important;
    box-shadow: 0 0 25px #0f0 !important;
    transition: none;
  }
  #score {
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
    font-size: 24px; letter-spacing: 3px;
  }
  #info {
    position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
    font-size: 14px; color: #aaa; max-width: 90vw; text-align: center;
    user-select:none;
  }
</style>
</head>
<body>
<div id="game">
  <div id="score">分數: 0</div>
  <div id="info">首次點擊開始遊戲，依節奏點擊下方方塊</div>
  <div id="lanes">
    <div class="lane" data-index="0"></div>
    <div class="lane" data-index="1"></div>
    <div class="lane" data-index="2"></div>
    <div class="lane" data-index="3"></div>
  </div>
</div>

<!-- 音樂：用免費授權BGM -->
<audio id="bgm" src="https://cdn.jsdelivr.net/gh/jacksin123/mp3cdn@main/bgm.mp3" preload="auto"></audio>
<audio id="hitSound" src="https://cdn.jsdelivr.net/gh/jacksin123/mp3cdn@main/hit.wav" preload="auto"></audio>
<audio id="missSound" src="https://cdn.jsdelivr.net/gh/jacksin123/mp3cdn@main/miss.wav" preload="auto"></audio>

<script>
(() => {
  const lanes = [...document.querySelectorAll('.lane')];
  const scoreEl = document.getElementById('score');
  const infoEl = document.getElementById('info');
  const bgm = document.getElementById('bgm');
  const hitSound = document.getElementById('hitSound');
  const missSound = document.getElementById('missSound');

  let notes = [];
  let score = 0;
  let gameStart = false;
  const hitLineY = 20;  // 距離底部擊打區高度
  const hitTolerance = 40; // 可接受誤差像素

  // 節奏資料（毫秒，lane 0~3）
  const beatMap = [
    {time: 0, lane:0},{time: 500, lane:1},{time: 1000, lane:2},{time:1500, lane:3},
    {time: 2000, lane:0},{time: 2500, lane:1},{time: 3000, lane:2},{time: 3500, lane:3},
    {time: 4000, lane:0},{time: 4500, lane:1},{time: 5000, lane:2},{time: 5500, lane:3},
    {time: 6000, lane:0},{time: 6500, lane:1},{time: 7000, lane:2},{time: 7500, lane:3},
    {time: 8000, lane:0},{time: 8500, lane:1},{time: 9000, lane:2},{time: 9500, lane:3},
  ];

  // 音符掉落速度 (像素/ms)
  const speed = 0.25;
  let startTime = null;

  function createNote(lane, spawnTime) {
    const laneDiv = lanes[lane];
    const note = document.createElement('div');
    note.classList.add('note');
    laneDiv.appendChild(note);
    return {elem: note, lane, spawnTime, y: 180, hit:false};
  }

  function startGame() {
    if (gameStart) return;
    gameStart = true;
    score = 0;
    scoreEl.textContent = '分數: 0';
    infoEl.textContent = '遊戲進行中...';
    startTime = null;
    notes.forEach(n => n.elem.remove());
    notes = [];

    // 深複製節奏陣列以免破壞原始資料
    upcomingBeats = beatMap.map(b => ({...b}));

    bgm.currentTime = 0;
    bgm.play();
    requestAnimationFrame(gameLoop);
  }

  let upcomingBeats = [];

  function gameLoop(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;

    // 產生音符 (提前2秒生成)
    while (upcomingBeats.length > 0 && upcomingBeats[0].time <= elapsed + 2000) {
      const beat = upcomingBeats.shift();
      notes.push(createNote(beat.lane, beat.time));
    }

    // 更新音符位置
    notes.forEach(note => {
      if (note.hit) return;
      note.y = 180 - (elapsed - note.spawnTime) * speed;
      if (note.y < -60) { // 跳過擊打區，視為miss
        note.hit = true;
        note.elem.remove();
        missSound.currentTime = 0;
        missSound.play();
      } else {
        note.elem.style.bottom = note.y + 'px';
      }
    });

    // 過濾已處理音符
    notes = notes.filter(n => !n.hit);

    if (!bgm.paused) {
      requestAnimationFrame(gameLoop);
    } else {
      infoEl.textContent = '遊戲結束！分數：' + score;
      gameStart = false;
    }
  }

  // 判定擊打音符
  function hitLane(lane) {
    if (!gameStart) return;
    lanes.forEach((l, i) => {
      if (i === lane) {
        l.classList.add('active');
        setTimeout(() => l.classList.remove('active'), 150);
      }
    });

    // 找最近且未被擊中的音符
    const candidates = notes.filter(n => n.lane === lane && !n.hit);
    if (candidates.length === 0) {
      missSound.currentTime = 0;
      missSound.play();
      return;
    }

    // 找距離擊打線最近的音符
    let nearest = candidates.reduce((prev, curr) => {
      return Math.abs(curr.y - hitLineY) < Math.abs(prev.y - hitLineY) ? curr : prev;
    });

    // 判斷是否在可接受範圍內
    if (Math.abs(nearest.y - hitLineY) <= hitTolerance) {
      nearest.hit = true;
      nearest.elem.classList.add('hit');
      score++;
      scoreEl.textContent = '分數: ' + score;
      hitSound.currentTime = 0;
      hitSound.play();
      setTimeout(() => nearest.elem.remove(), 300);
    } else {
      missSound.currentTime = 0;
      missSound.play();
    }
  }

  // 螢幕觸控判斷擊打哪個 lane
  document.getElementById('game').addEventListener('touchstart', e => {
    e.preventDefault();
    for (let touch of e.touches) {
      const x = touch.clientX;
      const laneWidth = window.innerWidth / lanes.length;
      const laneIndex = Math.floor(x / laneWidth);
      hitLane(laneIndex);
    }
  }, {passive:false});

  // 點擊事件（手機測試用）
  document.getElementById('game').addEventListener('click', e => {
    const x = e.clientX;
    const laneWidth = window.innerWidth / lanes.length;
    const laneIndex = Math.floor(x / laneWidth);
    hitLane(laneIndex);
  });

  // 點擊頁面第一次啟動遊戲並播放音樂（因手機限制需要互動觸發）
  document.body.addEventListener('click', () => {
    if (!gameStart) startGame();
  }, {once:true});

})();
</script>
</body>
</html>
