<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>下落式節奏遊戲</title>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; }
    #startOverlay {
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:24px;
      cursor:pointer;
      background:rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="startOverlay">點擊開始遊戲</div>
  <audio id="music" src="https://www.bensound.com/bensound-music/bensound-energy.mp3"></audio>
  <script>
  (function(){
    const canvas = document.getElementById('game'),
          ctx = canvas.getContext('2d'),
          startOverlay = document.getElementById('startOverlay'),
          music = document.getElementById('music');

    let cw, ch;
    function resize(){ cw = canvas.width = window.innerWidth; ch = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    const lanes = 4,
          laneW = () => cw / lanes,
          receptorY = () => ch - 100,
          noteSize = () => laneW() * 0.8,
          hitMargin = 30,
          preSpawnTime = 2000,
          beatInterval = 600,
          pattern = [0,1,2,3,1,0,3,2,0,1,2,3,2,1,3,0];

    let speed, notes = [], active = [], startTime = 0, playing = false;

    function initNotes(){
      notes = pattern.map((lane, i) => {
        const t = i * beatInterval;
        return { lane, t, spawnTime: t - preSpawnTime, added:false, hit:false };
      });
    }

    function startGame(){
      if (playing) return;
      resize();
      speed = ch / preSpawnTime;
      initNotes();
      startTime = performance.now();
      music.play();
      playing = true;
      startOverlay.style.display = 'none';
      requestAnimationFrame(loop);
    }

    startOverlay.addEventListener('click', startGame);

    document.addEventListener('keydown', e => {
      const keyMap = { 'a':0, 's':1, 'd':2, 'f':3 };
      if (keyMap[e.key] != null) tryHit(keyMap[e.key]);
    });

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const x = e.touches[0].clientX;
      const lane = Math.floor(x / laneW());
      tryHit(lane);
    });

    function tryHit(lane){
      const now = performance.now() - startTime;
      for (let i = 0; i < active.length; i++){
        const n = active[i];
        if (n.lane === lane && !n.hit){
          const y = (now - n.spawnTime) * speed;
          if (Math.abs(y - receptorY()) <= hitMargin){
            n.hit = true;
            active.splice(i, 1);
          }
          break;
        }
      }
    }

    function loop(){
      const now = performance.now() - startTime;
      // 生成 notes
      notes.forEach(n => {
        if (!n.added && now >= n.spawnTime){
          n.added = true;
          active.push(n);
        }
      });

      // 繪製
      ctx.clearRect(0, 0, cw, ch);

      // receptor
      for (let i = 0; i < lanes; i++){
        ctx.fillStyle = '#333';
        ctx.fillRect(i * laneW() + laneW()*0.1, receptorY(), noteSize(), 20);
      }

      // notes
      active.forEach(n => {
        const y = (now - n.spawnTime) * speed;
        ctx.fillStyle = '#0f0';
        ctx.fillRect(n.lane * laneW() + laneW()*0.1, y, noteSize(), noteSize());
      });

      // 移除超過底部
      active = active.filter(n => {
        const y = (now - n.spawnTime) * speed;
        return y < ch + noteSize();
      });

      if (playing && (active.length > 0 || notes.some(n => !n.added))){
        requestAnimationFrame(loop);
      }
    }
  })();
  </script>
</body>
</html>
